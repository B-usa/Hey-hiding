<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Corbeille's Corbeille - Gestionnaire Personnel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            box-sizing: border-box;
        }
        
        .drag-over {
            border-color: #10b981 !important;
            background-color: rgba(16, 185, 129, 0.1) !important;
        }
        
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .slide-out {
            animation: slideOut 0.3s ease-out forwards;
        }
        
        @keyframes slideOut {
            to { opacity: 0; transform: translateX(100px); }
        }
        
        .progress-bar {
            transition: width 0.3s ease;
        }
        
        .file-preview {
            max-width: 100px;
            max-height: 100px;
            object-fit: cover;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            max-width: 400px;
            padding: 16px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            animation: slideInRight 0.3s ease-out;
        }
        
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .notification.success { background-color: #059669; }
        .notification.error { background-color: #dc2626; }
        .notification.warning { background-color: #d97706; }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 min-h-full text-white">
    <div class="container mx-auto px-4 py-6 max-w-7xl">
        <!-- Header -->
        <div class="text-center mb-6">
            <h1 class="text-4xl font-bold mb-2 bg-gradient-to-r from-emerald-400 to-blue-500 bg-clip-text text-transparent">
                üõ°Ô∏è Corbeille's Corbeille Pro
            </h1>
            <p class="text-lg text-gray-300">Votre gestionnaire personnel de sauvegarde - Prot√©gez vos fichiers importants</p>
        </div>

        <!-- Quick Stats -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
            <div class="bg-white/10 backdrop-blur-sm rounded-lg p-4 border border-white/20">
                <div class="text-center">
                    <div class="text-2xl mb-1">üìÅ</div>
                    <div class="text-xl font-bold" id="totalFiles">0</div>
                    <div class="text-xs text-gray-300">Fichiers</div>
                </div>
            </div>
            <div class="bg-white/10 backdrop-blur-sm rounded-lg p-4 border border-white/20">
                <div class="text-center">
                    <div class="text-2xl mb-1">üíæ</div>
                    <div class="text-xl font-bold" id="totalSize">0 MB</div>
                    <div class="text-xs text-gray-300">Stockage</div>
                </div>
            </div>
            <div class="bg-white/10 backdrop-blur-sm rounded-lg p-4 border border-white/20">
                <div class="text-center">
                    <div class="text-2xl mb-1">üóëÔ∏è</div>
                    <div class="text-xl font-bold" id="trashedFiles">0</div>
                    <div class="text-xs text-gray-300">Supprim√©s</div>
                </div>
            </div>
            <div class="bg-white/10 backdrop-blur-sm rounded-lg p-4 border border-white/20">
                <div class="text-center">
                    <div class="text-2xl mb-1">üõ°Ô∏è</div>
                    <div class="text-xl font-bold" id="protectedFiles">0</div>
                    <div class="text-xs text-gray-300">Prot√©g√©s</div>
                </div>
            </div>
        </div>

        <!-- File Upload Zone -->
        <div class="bg-white/10 backdrop-blur-sm rounded-xl p-6 border-2 border-dashed border-white/30 mb-6 transition-all duration-300" 
             id="dropZone"
             ondrop="handleDrop(event)" 
             ondragover="handleDragOver(event)" 
             ondragleave="handleDragLeave(event)">
            <div class="text-center">
                <div class="text-6xl mb-4">üì§</div>
                <h3 class="text-xl font-semibold mb-2">Glissez vos fichiers ici</h3>
                <p class="text-gray-300 mb-4">ou cliquez pour s√©lectionner</p>
                <input type="file" id="fileInput" multiple class="hidden" onchange="handleFileSelect(event)">
                <button onclick="document.getElementById('fileInput').click()" 
                        class="bg-blue-600 hover:bg-blue-700 px-6 py-3 rounded-lg font-semibold transition-colors">
                    üìÅ Choisir des fichiers
                </button>
            </div>
            <div id="uploadProgress" class="hidden mt-4">
                <div class="bg-gray-700 rounded-full h-2">
                    <div class="bg-blue-600 h-2 rounded-full progress-bar" style="width: 0%"></div>
                </div>
                <p class="text-sm text-gray-300 mt-2 text-center" id="uploadStatus">T√©l√©chargement...</p>
            </div>
        </div>

        <!-- Search and Filters -->
        <div class="bg-white/10 backdrop-blur-sm rounded-xl p-4 border border-white/20 mb-6">
            <div class="flex flex-wrap gap-4 items-center">
                <div class="flex-1 min-w-64">
                    <input type="text" id="searchInput" placeholder="üîç Rechercher vos fichiers..." 
                           class="w-full px-4 py-2 rounded-lg bg-white/20 border border-white/30 text-white placeholder-gray-300"
                           oninput="filterFiles()">
                </div>
                <select id="typeFilter" class="px-4 py-2 rounded-lg bg-white/20 border border-white/30 text-white" onchange="filterFiles()">
                    <option value="all">Tous les types</option>
                    <option value="image">üñºÔ∏è Images</option>
                    <option value="document">üìÑ Documents</option>
                    <option value="video">üé• Vid√©os</option>
                    <option value="audio">üéµ Audio</option>
                    <option value="archive">üì¶ Archives</option>
                    <option value="other">üìã Autres</option>
                </select>
                <select id="sortFilter" class="px-4 py-2 rounded-lg bg-white/20 border border-white/30 text-white" onchange="filterFiles()">
                    <option value="newest">Plus r√©cent</option>
                    <option value="oldest">Plus ancien</option>
                    <option value="name">Nom A-Z</option>
                    <option value="size">Taille</option>
                </select>
                <button onclick="exportBackup()" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded-lg font-semibold transition-colors">
                    üíæ Exporter
                </button>
            </div>
        </div>

        <!-- File Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-6">
            <!-- Active Files -->
            <div class="bg-white/10 backdrop-blur-sm rounded-xl p-6 border border-white/20">
                <h3 class="text-xl font-semibold mb-4 flex items-center gap-2">
                    üìÅ <span>Mes Fichiers</span>
                    <span class="text-sm bg-blue-600 px-2 py-1 rounded-full" id="activeCount">0</span>
                </h3>
                <div id="activeFiles" class="space-y-3 max-h-96 overflow-y-auto">
                    <div class="text-gray-400 text-center py-8">
                        <div class="text-4xl mb-2">üìÇ</div>
                        <p>Ajoutez vos premiers fichiers</p>
                    </div>
                </div>
            </div>

            <!-- Trash -->
            <div class="bg-white/10 backdrop-blur-sm rounded-xl p-6 border border-white/20">
                <h3 class="text-xl font-semibold mb-4 flex items-center gap-2">
                    üóëÔ∏è <span>Corbeille</span>
                    <span class="text-sm bg-orange-600 px-2 py-1 rounded-full" id="trashCount">0</span>
                </h3>
                <div id="trashFiles" class="space-y-3 max-h-96 overflow-y-auto">
                    <div class="text-gray-400 text-center py-8">
                        <div class="text-4xl mb-2">üóëÔ∏è</div>
                        <p>Corbeille vide</p>
                    </div>
                </div>
                <button onclick="emptyTrash()" class="w-full mt-4 bg-red-600 hover:bg-red-700 px-4 py-2 rounded-lg font-semibold transition-colors">
                    üî• Vider la corbeille
                </button>
            </div>

            <!-- Protected Backup -->
            <div class="bg-gradient-to-br from-emerald-900/30 to-blue-900/30 backdrop-blur-sm rounded-xl p-6 border border-emerald-500/30">
                <h3 class="text-xl font-semibold mb-4 flex items-center gap-2 text-emerald-300">
                    üõ°Ô∏è <span>Sauvegarde Prot√©g√©e</span>
                    <span class="text-sm bg-emerald-600 px-2 py-1 rounded-full" id="protectedCount">0</span>
                </h3>
                <div id="protectedFiles" class="space-y-3 max-h-96 overflow-y-auto">
                    <div class="text-gray-400 text-center py-8">
                        <div class="text-4xl mb-2">üõ°Ô∏è</div>
                        <p>Aucune sauvegarde prot√©g√©e</p>
                    </div>
                </div>
                <button onclick="showRecoveryTools()" class="w-full mt-4 bg-emerald-600 hover:bg-emerald-700 px-4 py-2 rounded-lg font-semibold transition-colors">
                    üîß Outils de r√©cup√©ration
                </button>
            </div>
        </div>

        <!-- Recovery Tools Modal -->
        <div id="recoveryModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden items-center justify-center z-50">
            <div class="bg-gradient-to-br from-slate-800 to-purple-800 rounded-xl p-8 max-w-4xl w-full mx-4 border border-white/20 max-h-[90vh] overflow-y-auto">
                <h3 class="text-2xl font-bold mb-6 text-center">üîß Outils de R√©cup√©ration Avanc√©e</h3>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div class="bg-white/10 rounded-lg p-4">
                        <h4 class="font-semibold mb-3">üîç Recherche Avanc√©e</h4>
                        <input type="text" id="advancedSearch" placeholder="Nom du fichier..." 
                               class="w-full px-3 py-2 rounded bg-white/20 border border-white/30 text-white placeholder-gray-300 mb-3">
                        <input type="date" id="dateFrom" class="w-full px-3 py-2 rounded bg-white/20 border border-white/30 text-white mb-2">
                        <input type="date" id="dateTo" class="w-full px-3 py-2 rounded bg-white/20 border border-white/30 text-white mb-3">
                        <button onclick="advancedSearch()" class="w-full bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded font-semibold transition-colors">
                            Rechercher
                        </button>
                    </div>
                    
                    <div class="bg-white/10 rounded-lg p-4">
                        <h4 class="font-semibold mb-3">üìä Statistiques</h4>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span>Fichiers r√©cup√©rables:</span>
                                <span id="recoverableCount">0</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Espace r√©cup√©rable:</span>
                                <span id="recoverableSize">0 MB</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Derni√®re sauvegarde:</span>
                                <span id="lastBackup">Jamais</span>
                            </div>
                        </div>
                        <button onclick="createFullBackup()" class="w-full mt-3 bg-green-600 hover:bg-green-700 px-4 py-2 rounded font-semibold transition-colors">
                            üíæ Sauvegarde compl√®te
                        </button>
                    </div>
                </div>
                
                <div id="recoveryResults" class="mb-6">
                    <!-- Results will appear here -->
                </div>
                
                <div class="flex gap-4">
                    <button onclick="closeRecoveryTools()" class="flex-1 bg-gray-600 hover:bg-gray-700 px-6 py-3 rounded-lg font-semibold transition-colors">
                        Fermer
                    </button>
                    <button onclick="recoverAll()" class="flex-1 bg-emerald-600 hover:bg-emerald-700 px-6 py-3 rounded-lg font-semibold transition-colors">
                        ‚ôªÔ∏è Tout r√©cup√©rer
                    </button>
                </div>
            </div>
        </div>

        <!-- Download Troubleshooting Panel -->
        <div class="bg-yellow-900/20 backdrop-blur-sm rounded-xl p-4 border border-yellow-500/30 mb-6">
            <h3 class="text-lg font-semibold mb-3 text-yellow-300">üîß Probl√®me de t√©l√©chargement?</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                <div>
                    <p class="font-semibold mb-2">‚úÖ V√©rifiez:</p>
                    <ul class="space-y-1 text-gray-300">
                        <li>‚Ä¢ Bloqueur de pop-ups d√©sactiv√©</li>
                        <li>‚Ä¢ Dossier T√©l√©chargements accessible</li>
                        <li>‚Ä¢ Espace disque suffisant</li>
                    </ul>
                </div>
                <div>
                    <p class="font-semibold mb-2">üîÑ Solutions:</p>
                    <ul class="space-y-1 text-gray-300">
                        <li>‚Ä¢ Clic droit ‚Üí "Enregistrer sous"</li>
                        <li>‚Ä¢ Essayer un autre navigateur</li>
                        <li>‚Ä¢ Vider le cache navigateur</li>
                    </ul>
                </div>
                <div>
                    <p class="font-semibold mb-2">üì± Alternative:</p>
                    <button onclick="showFileContent()" class="bg-blue-600 hover:bg-blue-700 px-3 py-2 rounded text-sm font-semibold transition-colors">
                        Voir contenu fichier
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let files = JSON.parse(localStorage.getItem('corbeilleFiles') || '[]');
        let trashedFiles = JSON.parse(localStorage.getItem('corbeilleTrash') || '[]');
        let protectedFiles = JSON.parse(localStorage.getItem('corbeilleProtected') || '[]');
        let fileIdCounter = parseInt(localStorage.getItem('corbeilleCounter') || '1');

        function saveToStorage() {
            localStorage.setItem('corbeilleFiles', JSON.stringify(files));
            localStorage.setItem('corbeilleTrash', JSON.stringify(trashedFiles));
            localStorage.setItem('corbeilleProtected', JSON.stringify(protectedFiles));
            localStorage.setItem('corbeilleCounter', fileIdCounter.toString());
        }

        function getFileType(fileName) {
            const ext = fileName.split('.').pop().toLowerCase();
            const types = {
                'jpg': 'image', 'jpeg': 'image', 'png': 'image', 'gif': 'image', 'webp': 'image', 'svg': 'image',
                'pdf': 'document', 'doc': 'document', 'docx': 'document', 'txt': 'document', 'rtf': 'document',
                'mp4': 'video', 'avi': 'video', 'mov': 'video', 'wmv': 'video', 'flv': 'video', 'webm': 'video',
                'mp3': 'audio', 'wav': 'audio', 'flac': 'audio', 'aac': 'audio', 'ogg': 'audio',
                'zip': 'archive', 'rar': 'archive', '7z': 'archive', 'tar': 'archive', 'gz': 'archive'
            };
            return types[ext] || 'other';
        }

        function getFileIcon(type) {
            const icons = {
                'image': 'üñºÔ∏è',
                'document': 'üìÑ',
                'video': 'üé•',
                'audio': 'üéµ',
                'archive': 'üì¶',
                'other': 'üìã'
            };
            return icons[type] || 'üìã';
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideInRight 0.3s ease-out reverse';
                setTimeout(() => notification.remove(), 300);
            }, 4000);
        }

        function handleDragOver(e) {
            e.preventDefault();
            document.getElementById('dropZone').classList.add('drag-over');
        }

        function handleDragLeave(e) {
            e.preventDefault();
            document.getElementById('dropZone').classList.remove('drag-over');
        }

        function handleDrop(e) {
            e.preventDefault();
            document.getElementById('dropZone').classList.remove('drag-over');
            const droppedFiles = Array.from(e.dataTransfer.files);
            processFiles(droppedFiles);
        }

        function handleFileSelect(e) {
            const selectedFiles = Array.from(e.target.files);
            processFiles(selectedFiles);
        }

        async function processFiles(fileList) {
            const progressBar = document.querySelector('.progress-bar');
            const uploadProgress = document.getElementById('uploadProgress');
            const uploadStatus = document.getElementById('uploadStatus');
            
            uploadProgress.classList.remove('hidden');
            
            for (let i = 0; i < fileList.length; i++) {
                const file = fileList[i];
                const progress = ((i + 1) / fileList.length) * 100;
                
                progressBar.style.width = progress + '%';
                uploadStatus.textContent = `Traitement: ${file.name} (${i + 1}/${fileList.length})`;
                
                await addFileToSystem(file);
                await new Promise(resolve => setTimeout(resolve, 200));
            }
            
            uploadProgress.classList.add('hidden');
            document.getElementById('fileInput').value = '';
            updateDisplay();
            showNotification(`‚úÖ ${fileList.length} fichier(s) ajout√©(s) avec succ√®s`);
        }

        async function addFileToSystem(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const fileData = {
                        id: fileIdCounter++,
                        name: file.name,
                        type: getFileType(file.name),
                        size: file.size,
                        data: e.target.result,
                        dateAdded: new Date().toISOString(),
                        dateModified: new Date(file.lastModified).toISOString(),
                        protected: false
                    };
                    
                    files.push(fileData);
                    saveToStorage();
                    resolve();
                };
                reader.onerror = function() {
                    showNotification(`‚ùå Erreur lors de la lecture de ${file.name}`, 'error');
                    reject();
                };
                reader.readAsDataURL(file);
            });
        }

        function downloadFile(fileId, fromProtected = false) {
            const sourceArray = fromProtected ? protectedFiles : files;
            const file = sourceArray.find(f => f.id === fileId);
            
            if (!file) {
                showNotification('‚ùå Fichier non trouv√©', 'error');
                return;
            }
            
            if (!file.data) {
                showNotification('‚ùå Donn√©es du fichier corrompues', 'error');
                return;
            }
            
            try {
                // Method 1: Standard download
                const link = document.createElement('a');
                link.href = file.data;
                link.download = file.name;
                link.style.display = 'none';
                
                // Add to DOM temporarily
                document.body.appendChild(link);
                
                // Try to trigger download
                link.click();
                
                // Clean up
                setTimeout(() => {
                    document.body.removeChild(link);
                }, 100);
                
                showNotification(`üíæ T√©l√©chargement de "${file.name}" d√©marr√©`);
                
                // Fallback method after 2 seconds if first method fails
                setTimeout(() => {
                    downloadFileFallback(file);
                }, 2000);
                
            } catch (error) {
                console.error('Download error:', error);
                downloadFileFallback(file);
            }
        }

        function downloadFileFallback(file) {
            try {
                // Method 2: Open in new window for manual save
                const newWindow = window.open('', '_blank');
                if (newWindow) {
                    newWindow.document.write(`
                        <html>
                            <head><title>T√©l√©charger ${file.name}</title></head>
                            <body style="font-family: Arial, sans-serif; padding: 20px; background: #1a1a1a; color: white;">
                                <h2>üìÅ Fichier: ${file.name}</h2>
                                <p>Si le t√©l√©chargement automatique ne fonctionne pas:</p>
                                <ol>
                                    <li>Clic droit sur le lien ci-dessous</li>
                                    <li>S√©lectionnez "Enregistrer sous..." ou "Save as..."</li>
                                    <li>Choisissez l'emplacement de sauvegarde</li>
                                </ol>
                                <p><a href="${file.data}" download="${file.name}" style="color: #60a5fa; font-size: 18px;">üíæ T√©l√©charger ${file.name}</a></p>
                                <p style="margin-top: 30px; font-size: 12px; color: #888;">
                                    Taille: ${formatFileSize(file.size)} | 
                                    Type: ${file.type} | 
                                    Ajout√©: ${new Date(file.dateAdded).toLocaleDateString('fr-FR')}
                                </p>
                            </body>
                        </html>
                    `);
                    newWindow.document.close();
                    
                    // Auto-trigger download in new window
                    setTimeout(() => {
                        const link = newWindow.document.querySelector('a[download]');
                        if (link) link.click();
                    }, 500);
                } else {
                    showNotification('‚ùå Veuillez autoriser les pop-ups pour t√©l√©charger', 'warning');
                }
            } catch (error) {
                showNotification('‚ùå Impossible de t√©l√©charger. Essayez un autre navigateur.', 'error');
            }
        }

        function showFileContent() {
            const allFiles = [...files, ...trashedFiles, ...protectedFiles];
            if (allFiles.length === 0) {
                showNotification('‚ùå Aucun fichier disponible', 'warning');
                return;
            }
            
            const fileList = allFiles.map(file => `
                <div style="margin: 10px 0; padding: 10px; border: 1px solid #444; border-radius: 5px;">
                    <strong>${file.name}</strong> (${formatFileSize(file.size)})<br>
                    <a href="${file.data}" download="${file.name}" style="color: #60a5fa;">üíæ T√©l√©charger</a>
                </div>
            `).join('');
            
            const newWindow = window.open('', '_blank');
            if (newWindow) {
                newWindow.document.write(`
                    <html>
                        <head><title>Tous vos fichiers sauvegard√©s</title></head>
                        <body style="font-family: Arial, sans-serif; padding: 20px; background: #1a1a1a; color: white;">
                            <h1>üìÅ Vos fichiers sauvegard√©s</h1>
                            <p>Clic droit ‚Üí "Enregistrer sous" sur chaque lien pour t√©l√©charger:</p>
                            ${fileList}
                        </body>
                    </html>
                `);
                newWindow.document.close();
            }
        }

        function deleteFile(fileId, permanent = false) {
            const fileIndex = files.findIndex(f => f.id === fileId);
            if (fileIndex !== -1) {
                const file = files[fileIndex];
                
                if (permanent) {
                    file.dateDeleted = new Date().toISOString();
                    protectedFiles.push(file);
                } else {
                    trashedFiles.push(file);
                }
                
                files.splice(fileIndex, 1);
                saveToStorage();
                updateDisplay();
                
                const message = permanent ? 
                    `üõ°Ô∏è "${file.name}" sauvegard√© dans la protection ultime` :
                    `üóëÔ∏è "${file.name}" d√©plac√© vers la corbeille`;
                showNotification(message);
            }
        }

        function restoreFile(fileId, fromProtected = false) {
            const sourceArray = fromProtected ? protectedFiles : trashedFiles;
            const fileIndex = sourceArray.findIndex(f => f.id === fileId);
            
            if (fileIndex !== -1) {
                const file = sourceArray[fileIndex];
                delete file.dateDeleted;
                files.push(file);
                sourceArray.splice(fileIndex, 1);
                saveToStorage();
                updateDisplay();
                
                const source = fromProtected ? 'sauvegarde prot√©g√©e' : 'corbeille';
                showNotification(`‚ôªÔ∏è "${file.name}" r√©cup√©r√© depuis la ${source}`);
            }
        }

        function toggleProtection(fileId) {
            const file = files.find(f => f.id === fileId);
            if (file) {
                file.protected = !file.protected;
                saveToStorage();
                updateDisplay();
                
                const status = file.protected ? 'prot√©g√©' : 'd√©prot√©g√©';
                showNotification(`üõ°Ô∏è "${file.name}" ${status}`);
            }
        }

        function emptyTrash() {
            if (trashedFiles.length === 0) {
                showNotification('üóëÔ∏è La corbeille est d√©j√† vide', 'warning');
                return;
            }
            
            const count = trashedFiles.length;
            trashedFiles.forEach(file => {
                file.dateDeleted = new Date().toISOString();
                protectedFiles.push(file);
            });
            
            trashedFiles = [];
            saveToStorage();
            updateDisplay();
            showNotification(`üõ°Ô∏è ${count} fichier(s) d√©plac√©(s) vers la sauvegarde prot√©g√©e`);
        }

        function filterFiles() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const typeFilter = document.getElementById('typeFilter').value;
            const sortFilter = document.getElementById('sortFilter').value;
            
            let filteredFiles = [...files];
            
            if (searchTerm) {
                filteredFiles = filteredFiles.filter(file => 
                    file.name.toLowerCase().includes(searchTerm)
                );
            }
            
            if (typeFilter !== 'all') {
                filteredFiles = filteredFiles.filter(file => file.type === typeFilter);
            }
            
            filteredFiles.sort((a, b) => {
                switch(sortFilter) {
                    case 'newest':
                        return new Date(b.dateAdded) - new Date(a.dateAdded);
                    case 'oldest':
                        return new Date(a.dateAdded) - new Date(b.dateAdded);
                    case 'name':
                        return a.name.localeCompare(b.name);
                    case 'size':
                        return b.size - a.size;
                    default:
                        return 0;
                }
            });
            
            displayFiles(filteredFiles);
        }

        function displayFiles(filesToShow = files) {
            const container = document.getElementById('activeFiles');
            
            if (filesToShow.length === 0) {
                container.innerHTML = `
                    <div class="text-gray-400 text-center py-8">
                        <div class="text-4xl mb-2">üìÇ</div>
                        <p>Aucun fichier trouv√©</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = filesToShow.map(file => `
                <div class="bg-white/10 rounded-lg p-3 fade-in">
                    <div class="flex items-center gap-3">
                        <div class="text-2xl">${getFileIcon(file.type)}</div>
                        <div class="flex-1 min-w-0">
                            <p class="font-semibold truncate ${file.protected ? 'text-emerald-300' : ''}">${file.name}</p>
                            <p class="text-xs text-gray-400">${formatFileSize(file.size)} ‚Ä¢ ${new Date(file.dateAdded).toLocaleDateString('fr-FR')}</p>
                        </div>
                        <div class="flex gap-1">
                            <button onclick="toggleProtection(${file.id})" 
                                    class="p-1 rounded text-xs ${file.protected ? 'bg-emerald-600 hover:bg-emerald-700' : 'bg-gray-600 hover:bg-gray-700'} transition-colors"
                                    title="${file.protected ? 'D√©prot√©ger' : 'Prot√©ger'}">
                                ${file.protected ? 'üõ°Ô∏è' : 'üîì'}
                            </button>
                            <button onclick="downloadFile(${file.id})" 
                                    class="p-1 rounded text-xs bg-blue-600 hover:bg-blue-700 transition-colors"
                                    title="T√©l√©charger">
                                üíæ
                            </button>
                            <button onclick="deleteFile(${file.id})" 
                                    class="p-1 rounded text-xs bg-orange-600 hover:bg-orange-700 transition-colors"
                                    title="Supprimer">
                                üóëÔ∏è
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function displayTrashFiles() {
            const container = document.getElementById('trashFiles');
            
            if (trashedFiles.length === 0) {
                container.innerHTML = `
                    <div class="text-gray-400 text-center py-8">
                        <div class="text-4xl mb-2">üóëÔ∏è</div>
                        <p>Corbeille vide</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = trashedFiles.map(file => `
                <div class="bg-white/10 rounded-lg p-3 fade-in">
                    <div class="flex items-center gap-3">
                        <div class="text-2xl">${getFileIcon(file.type)}</div>
                        <div class="flex-1 min-w-0">
                            <p class="font-semibold truncate text-orange-300">${file.name}</p>
                            <p class="text-xs text-gray-400">${formatFileSize(file.size)}</p>
                        </div>
                        <div class="flex gap-1">
                            <button onclick="restoreFile(${file.id})" 
                                    class="p-1 rounded text-xs bg-green-600 hover:bg-green-700 transition-colors"
                                    title="Restaurer">
                                ‚ôªÔ∏è
                            </button>
                            <button onclick="downloadFile(${file.id})" 
                                    class="p-1 rounded text-xs bg-blue-600 hover:bg-blue-700 transition-colors"
                                    title="T√©l√©charger">
                                üíæ
                            </button>
                            <button onclick="deleteFile(${file.id}, true)" 
                                    class="p-1 rounded text-xs bg-red-600 hover:bg-red-700 transition-colors"
                                    title="Supprimer d√©finitivement">
                                üî•
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function displayProtectedFiles() {
            const container = document.getElementById('protectedFiles');
            
            if (protectedFiles.length === 0) {
                container.innerHTML = `
                    <div class="text-gray-400 text-center py-8">
                        <div class="text-4xl mb-2">üõ°Ô∏è</div>
                        <p>Aucune sauvegarde prot√©g√©e</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = protectedFiles.map(file => `
                <div class="bg-emerald-900/20 rounded-lg p-3 border border-emerald-500/30 fade-in">
                    <div class="flex items-center gap-3">
                        <div class="text-2xl">${getFileIcon(file.type)}</div>
                        <div class="flex-1 min-w-0">
                            <p class="font-semibold truncate text-emerald-300">${file.name}</p>
                            <p class="text-xs text-gray-400">
                                ${formatFileSize(file.size)} ‚Ä¢ 
                                Supprim√©: ${file.dateDeleted ? new Date(file.dateDeleted).toLocaleDateString('fr-FR') : 'N/A'}
                            </p>
                        </div>
                        <div class="flex gap-1">
                            <button onclick="downloadFile(${file.id}, true)" 
                                    class="p-1 rounded text-xs bg-blue-600 hover:bg-blue-700 transition-colors"
                                    title="T√©l√©charger">
                                üíæ
                            </button>
                            <button onclick="restoreFile(${file.id}, true)" 
                                    class="p-1 rounded text-xs bg-emerald-600 hover:bg-emerald-700 transition-colors"
                                    title="R√©cup√©ration ultime">
                                ‚ú®
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function updateDisplay() {
            const totalSize = [...files, ...trashedFiles, ...protectedFiles]
                .reduce((sum, file) => sum + file.size, 0);
            
            document.getElementById('totalFiles').textContent = files.length;
            document.getElementById('totalSize').textContent = formatFileSize(totalSize);
            document.getElementById('trashedFiles').textContent = trashedFiles.length;
            document.getElementById('protectedFiles').textContent = protectedFiles.length;
            
            document.getElementById('activeCount').textContent = files.length;
            document.getElementById('trashCount').textContent = trashedFiles.length;
            document.getElementById('protectedCount').textContent = protectedFiles.length;
            
            filterFiles();
            displayTrashFiles();
            displayProtectedFiles();
        }

        function exportBackup() {
            const backup = {
                files,
                trashedFiles,
                protectedFiles,
                exportDate: new Date().toISOString(),
                version: '1.0'
            };
            
            const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `corbeille-backup-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            showNotification('üíæ Sauvegarde export√©e avec succ√®s');
        }

        function showRecoveryTools() {
            document.getElementById('recoveryModal').classList.remove('hidden');
            document.getElementById('recoveryModal').classList.add('flex');
            updateRecoveryStats();
            advancedSearch(); // Show all files by default
        }

        function closeRecoveryTools() {
            document.getElementById('recoveryModal').classList.add('hidden');
            document.getElementById('recoveryModal').classList.remove('flex');
        }

        function updateRecoveryStats() {
            const recoverableCount = trashedFiles.length + protectedFiles.length;
            const recoverableSize = [...trashedFiles, ...protectedFiles]
                .reduce((sum, file) => sum + file.size, 0);
            
            document.getElementById('recoverableCount').textContent = recoverableCount;
            document.getElementById('recoverableSize').textContent = formatFileSize(recoverableSize);
            
            const lastBackup = protectedFiles.length > 0 ? 
                new Date(Math.max(...protectedFiles.map(f => new Date(f.dateDeleted || f.dateAdded)))).toLocaleDateString('fr-FR') :
                'Jamais';
            document.getElementById('lastBackup').textContent = lastBackup;
        }

        function advancedSearch() {
            const searchTerm = document.getElementById('advancedSearch').value.toLowerCase();
            const dateFrom = document.getElementById('dateFrom').value;
            const dateTo = document.getElementById('dateTo').value;
            
            let results = [...trashedFiles, ...protectedFiles];
            
            if (searchTerm) {
                results = results.filter(file => file.name.toLowerCase().includes(searchTerm));
            }
            
            if (dateFrom) {
                results = results.filter(file => new Date(file.dateAdded) >= new Date(dateFrom));
            }
            
            if (dateTo) {
                results = results.filter(file => new Date(file.dateAdded) <= new Date(dateTo));
            }
            
            displayRecoveryResults(results);
        }

        function displayRecoveryResults(results) {
            const container = document.getElementById('recoveryResults');
            
            if (results.length === 0) {
                container.innerHTML = '<p class="text-gray-400 text-center py-4">Aucun r√©sultat trouv√©</p>';
                return;
            }
            
            container.innerHTML = `
                <h4 class="font-semibold mb-3">üîç R√©sultats de recherche (${results.length})</h4>
                <div class="space-y-2 max-h-64 overflow-y-auto">
                    ${results.map(file => `
                        <div class="bg-white/10 rounded-lg p-3 flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <span class="text-xl">${getFileIcon(file.type)}</span>
                                <div>
                                    <p class="font-semibold">${file.name}</p>
                                    <p class="text-sm text-gray-300">
                                        ${formatFileSize(file.size)} ‚Ä¢ 
                                        ${file.dateDeleted ? 'Supprim√©: ' + new Date(file.dateDeleted).toLocaleDateString('fr-FR') : 'Ajout√©: ' + new Date(file.dateAdded).toLocaleDateString('fr-FR')}
                                    </p>
                                </div>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="downloadFile(${file.id}, ${protectedFiles.includes(file)})" 
                                        class="bg-blue-600 hover:bg-blue-700 px-3 py-1 rounded text-sm font-semibold transition-colors"
                                        title="T√©l√©charger le fichier">
                                    üíæ T√©l√©charger
                                </button>
                                <button onclick="restoreFile(${file.id}, ${protectedFiles.includes(file)})" 
                                        class="bg-green-600 hover:bg-green-700 px-3 py-1 rounded text-sm font-semibold transition-colors">
                                    ‚ôªÔ∏è R√©cup√©rer
                                </button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function recoverAll() {
            const allRecoverable = [...trashedFiles, ...protectedFiles];
            if (allRecoverable.length === 0) {
                showNotification('Aucun fichier √† r√©cup√©rer', 'warning');
                return;
            }
            
            const count = allRecoverable.length;
            
            trashedFiles.forEach(file => {
                delete file.dateDeleted;
                files.push(file);
            });
            
            protectedFiles.forEach(file => {
                delete file.dateDeleted;
                files.push(file);
            });
            
            trashedFiles = [];
            protectedFiles = [];
            
            saveToStorage();
            updateDisplay();
            closeRecoveryTools();
            
            showNotification(`‚ôªÔ∏è ${count} fichier(s) r√©cup√©r√©(s) avec succ√®s`);
        }

        function createFullBackup() {
            const allFiles = [...files, ...trashedFiles, ...protectedFiles];
            if (allFiles.length === 0) {
                showNotification('Aucun fichier √† sauvegarder', 'warning');
                return;
            }
            
            exportBackup();
        }

        // Initialize the application
        updateDisplay();
        
        // Auto-save every 30 seconds
        setInterval(saveToStorage, 30000);
        
        // Show welcome message for new users
        if (files.length === 0 && trashedFiles.length === 0 && protectedFiles.length === 0) {
            setTimeout(() => {
                showNotification('üëã Bienvenue! Glissez vos fichiers pour commencer √† les prot√©ger');
            }, 1000);
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'98ddd7a8d7d80651',t:'MTc2MDM0ODA3OS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
